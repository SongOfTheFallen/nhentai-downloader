<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Manga Library</title>
	<style>
		/* permanently hide the rescan FAB – it is still in the markup for
   future use but invisible and unfocusable */
		.rescan-btn {
			display: none !important;
			pointer-events: none !important
		}


		/* ===== RESET ===== */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box
		}

		body {
			background: #1a1a1a;
			color: #fff;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			min-height: 100vh;
			padding: 20px;
			overflow: hidden
		}

		/* ===== LAYOUT ===== */
		.library-container {
			max-width: 1600px;
			margin: 0 auto
		}

		.reader-view {
			display: none;
			position: fixed;
			inset: 0;
			background: #000;
			z-index: 1000
		}

		.reader-view.active {
			display: flex;
			flex-direction: column
		}

		.reader-container {
			flex: 1;
			display: flex;
			justify-content: center;
			align-items: center;
			/* ← back to centred – prevents height mis-calculation */
			position: relative;
			overflow: hidden;
			/* ← keep the page inside the pane, so the bottom is visible */
		}

		/* ===== HEADER ===== */
		.header {
			text-align: center;
			margin-bottom: 18px
		}

		.header h1 {
			font-size: 2.2rem;
			font-weight: 700;
			background: linear-gradient(45deg, #4a9eff, #00d4ff);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent
		}

		.stats {
			color: #888;
			font-size: .85rem;
			margin-top: 2px
		}

		/* ===== SEARCH BAR ===== */
		.search-container {
			margin-bottom: 16px;
			position: sticky;
			top: 8px;
			z-index: 120;
			background: rgba(26, 26, 26, .9);
			backdrop-filter: blur(8px);
			padding: 8px 12px;
			border-radius: 8px;
			border: 1px solid #333;
			transition: .25s ease
		}

		.search-container.compact {
			padding: 3px 6px;
			transform: translateY(-60%);
			opacity: .85
		}

		.search-bar {
			width: 100%;
			padding: 8px 12px;
			font-size: .9rem;
			background: #2a2a2a;
			border: 2px solid #444;
			color: #fff;
			border-radius: 6px
		}

		.search-bar:focus {
			outline: none;
			border-color: #4a9eff;
			background: #333;
			box-shadow: 0 0 0 2px rgba(74, 158, 255, .15)
		}

		.search-hint {
			margin-top: 3px;
			color: #aaa;
			font-size: .7rem;
			text-align: center
		}

		.search-hint kbd {
			background: #333;
			padding: 0 3px;
			border-radius: 3px;
			font-size: .68rem;
			color: #4a9eff
		}

		/* ===== CONTROLS BAR ===== */
		.controls-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 8px
		}

		.results-count {
			color: #888;
			font-size: .78rem
		}

		.view-toggle {
			display: flex;
			gap: 6px
		}

		.toggle-btn {
			padding: 3px 9px;
			background: #2a2a2a;
			border: 1px solid #444;
			color: #fff;
			border-radius: 6px;
			font-size: .78rem;
			cursor: pointer
		}

		.toggle-btn.active {
			background: #4a9eff;
			border-color: #4a9eff
		}

		#previewToggle {
			min-width: 80px
		}

		/* ===== GRID ===== */
		.manga-container {
			max-height: 70vh;
			overflow: auto;
			border: 1px solid #222;
			border-radius: 6px
		}

		.manga-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
			gap: 14px;
			padding: 14px
		}

		.manga-grid.compact {
			grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
			gap: 9px
		}

		.manga-card {
			background: linear-gradient(135deg, #2a2a2a, #252525);
			border-radius: 8px;
			padding: 10px;
			cursor: pointer;
			border: 2px solid transparent;
			transition: .2s;
			display: flex;
			flex-direction: column;
			align-items: center
		}

		.manga-card:hover {
			transform: translateY(-4px);
			border-color: #4a9eff;
			box-shadow: 0 5px 16px rgba(74, 158, 255, .18)
		}

		.manga-thumb {
			width: 100%;
			height: auto;
			max-height: 220px;
			object-fit: contain;
			border-radius: 5px;
			margin-bottom: 6px;
			background: #222;
			display: block
		}

		.no-previews .manga-thumb {
			display: none !important
		}

		.manga-number {
			font-size: 1.5rem;
			font-weight: 800;
			color: #4a9eff;
			text-shadow: 0 0 10px rgba(74, 158, 255, .3);
			margin-bottom: 3px
		}

		.manga-info {
			font-size: .7rem;
			color: #bbb;
			margin-bottom: 2px;
			display: flex;
			align-items: center;
			gap: 4px
		}

		.manga-info::before {
			content: '•';
			color: #4a9eff
		}

		.manga-tags {
			margin-top: 5px;
			display: flex;
			flex-wrap: wrap;
			gap: 3px;
			justify-content: center
		}

		.tag {
			background: linear-gradient(45deg, #3a3a3a, #444);
			padding: 2px 6px;
			border-radius: 9px;
			font-size: .55rem;
			color: #ddd;
			border: 1px solid #555;
			white-space: nowrap
		}

		.tag:hover {
			background: linear-gradient(45deg, #4a9eff, #00d4ff);
			color: #fff
		}

		.tag.artist {
			background: linear-gradient(45deg, #ff6b6b, #ff8e8e)
		}

		.tag.character {
			background: linear-gradient(45deg, #4ecdc4, #7dd3d8)
		}

		.tag.parody {
			background: linear-gradient(45deg, #ffd93d, #ffe066);
			color: #333
		}

		.tag.category {
			background: linear-gradient(45deg, #a8e6cf, #c8f7c5);
			color: #333
		}

		.tag.language {
			background: linear-gradient(45deg, #ff8b94, #ffa8a8)
		}

		.tag.group {
			background: linear-gradient(45deg, #b4a7d6, #c5b9d9)
		}

		.no-results {
			text-align: center;
			color: #888;
			font-size: 1rem;
			margin-top: 40px;
			padding: 22px;
			background: #2a2a2a;
			border-radius: 8px;
			border: 2px dashed #444
		}

		/* ===== LOADER ===== */
		.loading-library {
			text-align: center;
			padding: 32px;
			font-size: .85rem;
			color: #888
		}

		.loading-spinner {
			width: 34px;
			height: 34px;
			border: 3px solid #333;
			border-top: 3px solid #4a9eff;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin: 12px auto
		}

		@keyframes spin {
			0% {
				transform: rotate(0)
			}

			100% {
				transform: rotate(360deg)
			}
		}

		.progress-bar {
			width: 100%;
			height: 6px;
			background: #333;
			border-radius: 3px;
			margin: 10px 0;
			overflow: hidden
		}

		.progress-fill {
			height: 100%;
			background: linear-gradient(90deg, #4a9eff, #00d4ff);
			width: 0%
		}

		/* ===== RESCAN FAB ===== */
		.rescan-btn {
			position: fixed;
			bottom: 18px;
			right: 18px;
			width: 38px;
			height: 38px;
			border-radius: 50%;
			background: #4a9eff;
			border: none;
			color: #fff;
			font-size: 1.3rem;
			cursor: pointer;
			opacity: .12;
			transition: .3s;
			z-index: 1500
		}

		.rescan-btn:hover {
			opacity: 1
		}

		/* ===== READER ===== */
		.manga-image {
			/* let the image scale to the full height that the
	   reader container actually has, so nothing is cut off */
			max-height: 100%;
			min-height: 0%;
			width: auto;
			object-fit: contain;
			border-radius: 8px;
			box-shadow: 0 7px 22px rgba(0, 0, 0, .5);
			display: none;
		}

		.manga-image.active {
			display: block;
			animation: fadeIn .2s ease-in-out
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: scale(.96)
			}

			to {
				opacity: 1;
				transform: scale(1)
			}
		}

		.nav-button {
			position: absolute;
			top: 50%;
			transform: translateY(-50%);
			background: rgba(0, 0, 0, .7);
			border: none;
			color: #fff;
			font-size: 1.9rem;
			width: 60px;
			height: 90px;
			cursor: pointer;
			backdrop-filter: blur(10px);
			opacity: .75;
			transition: .2s
		}

		.nav-button:hover {
			background: rgba(74, 158, 255, .8);
			opacity: 1
		}

		.nav-button.prev {
			left: 12px;
			border-radius: 0 12px 12px 0
		}

		.nav-button.next {
			right: 12px;
			border-radius: 12px 0 0 12px
		}

		.top-controls {
			position: absolute;
			top: 12px;
			left: 12px;
			right: 12px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			z-index: 20
		}

		.back-button,
		.fullscreen-btn {
			background: rgba(0, 0, 0, .7);
			border: none;
			color: #fff;
			padding: 6px 12px;
			border-radius: 8px;
			font-size: .85rem;
			cursor: pointer
		}

		.back-button:hover,
		.fullscreen-btn:hover {
			background: rgba(74, 158, 255, .8)
		}

		.controls {
			background: linear-gradient(135deg, #2a2a2a, #252525);
			padding: 12px;
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 20px;
			border-top: 1px solid #333
		}

		.page-input {
			width: 66px;
			padding: 4px;
			background: #3a3a3a;
			border: 2px solid #555;
			color: #fff;
			text-align: center;
			border-radius: 6px;
			font-size: .85rem
		}

		.page-input:focus {
			outline: none;
			border-color: #4a9eff;
			box-shadow: 0 0 0 2px rgba(74, 158, 255, .15)
		}

		.loading,
		.error {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			text-align: center
		}

		.loading {
			color: #666;
			font-size: .95rem
		}

		.error {
			color: #ff6b6b;
			font-size: .9rem;
			padding: 18px;
			background: rgba(255, 107, 107, .1);
			border: 2px solid #ff6b6b;
			border-radius: 8px
		}

		/* ===== FULLSCREEN ===== */
		:fullscreen .top-controls,
		:fullscreen .controls,
		:fullscreen .nav-button {
			display: none !important
		}

		:fullscreen .manga-image {
			width: 100vw;
			height: 100vh;
			border-radius: 0;
			box-shadow: none
		}

		/* ===== RESPONSIVE ===== */
		@media(max-width:768px) {
			.manga-grid {
				grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
				gap: 8px
			}

			.manga-number {
				font-size: 1.25rem
			}

			.nav-button {
				width: 48px;
				height: 82px;
				font-size: 1.5rem
			}
		}
	</style>
</head>

<body>
	<!-- ===== LIBRARY VIEW ===== -->
	<div class="library-container" id="libraryView">
		<div class="header">
			<h1>Manga Library</h1>
			<div class="stats" id="statsDisplay">Scanning…</div>
		</div>

		<div class="search-container" id="searchContainer">
			<input id="searchBar" class="search-bar" placeholder="Search tags, artists, characters…"
				autocomplete="off">
			<div class="search-hint">Use <kbd>#123</kbd> for number • <kbd>Enter</kbd> search •
				<kbd>Esc</kbd> clear
			</div>
		</div>

		<div class="controls-bar">
			<div class="results-count" id="resultsCount"></div>
			<div class="view-toggle">
				<button class="toggle-btn active" id="normalView">Normal</button>
				<button class="toggle-btn" id="compactView">Compact</button>
				<button class="toggle-btn" id="previewToggle">Hide Thumbs</button>
			</div>
		</div>

		<div class="loading-library" id="loadingLibrary">
			<div class="loading-spinner"></div>
			<div class="progress-bar">
				<div class="progress-fill" id="progressFill"></div>
			</div>
		</div>

		<div class="manga-container" id="mangaContainer">
			<div class="manga-grid" id="mangaGrid"></div>
		</div>
		<button id="loadMoreBtn" class="toggle-btn" style="display:none;margin:14px auto">Load More</button>
		<div class="no-results" id="noResults" style="display:none">No manga found</div>
	</div>

	<!-- ===== READER VIEW ===== -->
	<div class="reader-view" id="readerView">
		<div class="reader-container" id="readerContainer">
			<div class="top-controls"><button class="back-button" onclick="backToLibrary()">←
					Library</button><button class="fullscreen-btn" onclick="toggleFullscreen()">⛶
					Fullscreen</button></div>
			<button class="nav-button prev" onclick="previousPage()">◀</button>
			<button class="nav-button next" onclick="nextPage()">▶</button>
			<div class="loading" id="loading" style="display:none">
				<div class="loading-spinner" style="width:30px;height:30px;border-width:3px"></div>
				<p>Loading…</p>
			</div>
			<div class="error" id="error" style="display:none">Failed to load page</div>
			<img class="manga-image" id="mangaImage" alt="manga page">
		</div>
		<div class="controls"><span>Page</span><input id="pageInput" class="page-input" type="number" min="1"
				value="1"><span>of <span id="totalPages">?</span></span></div>
	</div>

	<!-- ===== RESCAN FAB ===== -->
	<button id="rescanBtn" class="rescan-btn" title="Rescan">⟳</button>

	<script>



		let libraryScanned = false;   // new – remembers that we have already scanned
		/*****************************************************************************
		 * CONSTANTS & STATE                                                        *
		 *****************************************************************************/
		const supportedFormats = ["jpg", "jpeg", "png", "webp", "gif", "bmp"];
		const PAGE_SIZE = 250; // cards per batch
		let previewsOn = true;
		let itemsShown = PAGE_SIZE;
		let mangaData = [], filteredManga = [];
		let currentManga = null, currentPage = 1, maxPage = 1;

		/*****************************************************************************
		 * INIT                                                                     *
		 *****************************************************************************/
		window.addEventListener("DOMContentLoaded", () => {setupUI(); scanLibrary();});

		/*****************************************************************************
		 * UI SETUP                                                                 *
		 *****************************************************************************/
		let thumbObserver;
		function setupUI() {
			const sb = document.getElementById("searchBar");
			sb.addEventListener("input", e => filterLibrary(e.target.value.trim()));
			sb.addEventListener("keydown", e => {if (e.key === "Escape") {sb.value = ""; filterLibrary("");} if (e.key === "Enter") {filterLibrary(sb.value.trim());} });

			document.getElementById("normalView").onclick = () => setCompact(false);
			document.getElementById("compactView").onclick = () => setCompact(true);
			document.getElementById("previewToggle").onclick = togglePreviews;
			document.getElementById("loadMoreBtn").onclick = () => {itemsShown = Math.min(itemsShown + PAGE_SIZE, filteredManga.length); renderGrid();};
			document.getElementById("pageInput").addEventListener("change", e => {const n = parseInt(e.target.value, 10); if (!isNaN(n)) gotoPage(n);});

			document.addEventListener("keydown", e => {
				if (!document.getElementById("readerView").classList.contains("active")) return;
				if (e.key === "ArrowRight") nextPage();
				else if (e.key === "ArrowLeft") previousPage();
				else if (e.key.toLowerCase() === "f") {toggleFullscreen(); e.preventDefault();}
				else if (e.key === "Escape") {
					if (document.fullscreenElement) {
						document.exitFullscreen?.();     // first leave fullscreen
					} else {
						backToLibrary();                 // otherwise return to library
					}
				}
			});

			document.getElementById("readerContainer").addEventListener("click", e => {
				if (e.target.classList.contains("nav-button")) return;
				(e.clientX < window.innerWidth / 2 ? previousPage : nextPage)();
			});

			const scrollBox = document.getElementById("mangaContainer");
			scrollBox.addEventListener("scroll", () => document.getElementById("searchContainer").classList.toggle("compact", scrollBox.scrollTop > 35));

			thumbObserver = new IntersectionObserver(entries => {
				entries.forEach(ent => {if (ent.isIntersecting) {loadThumb(ent.target); thumbObserver.unobserve(ent.target);} });
			}, {root: scrollBox, rootMargin: "120px"});

			document.getElementById("rescanBtn").onclick = scanLibrary;




		}

		/*****************************************************************************
		 * LIBRARY SCAN                                                             *
		 *****************************************************************************/
		async function scanLibrary() {
			if (libraryScanned) return;        // ⬅️ skip if we’ve done it before
			libraryScanned = true;            // mark as done

			mangaData = [];                   // (original code continues)
			filteredManga = [];
			itemsShown = PAGE_SIZE;
			renderGrid();
			updateCounts();
			showLoader(true);
			let dirs = [];
			try {const html = await fetch("./").then(r => r.text()); const re = /href="(\d+)\/?"/g; let m; while ((m = re.exec(html))) dirs.push(+m[1]);} catch { }
			if (!dirs.length) {let gap = 0; for (let i = 1; i <= 9999 && gap < 40; i++) {try {if (await fetch(`${i}/meta.json`).then(r => r.ok)) {dirs.push(i); gap = 0;} else gap++;} catch {gap++;} } }
			dirs = [...new Set(dirs)].sort((a, b) => a - b);
			for (let i = 0; i < dirs.length; i++) {
				try {const meta = await fetch(`${dirs[i]}/meta.json`).then(r => r.ok ? r.json() : null); if (meta && meta.pages > 0) mangaData.push({number: dirs[i], ...meta});} catch { }
				progress((i + 1) / dirs.length);
			}
			mangaData.sort((a, b) => a.number - b.number);
			filteredManga = [...mangaData];
			showLoader(false); updateStats(); updateCounts(); renderGrid();
		}
		function showLoader(on) {document.getElementById("loadingLibrary").style.display = on ? "block" : "none";}
		function progress(f) {document.getElementById("progressFill").style.width = `${(f * 100).toFixed(1)}%`;}

		/*****************************************************************************
		 * FILTERING                                                                *
		 *****************************************************************************/
		function filterLibrary(q) {
			q = q.toLowerCase(); if (!q) filteredManga = [...mangaData];
			else if (q.startsWith("#")) {const n = q.slice(1); filteredManga = mangaData.filter(m => String(m.number).includes(n));}
			else {
				const words = q.split(/\s+/).filter(Boolean);
				filteredManga = mangaData.filter(m => {
					const tagset = [...(m.tags || []), ...(m.artists || []), ...(m.characters || []), ...(m.parodies || []), ...(m.groups || []), ...(m.languages || []), ...(m.categories || [])].map(t => t.name.toLowerCase());
					return words.every(w => tagset.some(t => t.includes(w)));
				});
			}
			itemsShown = PAGE_SIZE; updateCounts(); renderGrid();
		}

		/*****************************************************************************
		 * GRID RENDER                                                              *
		 *****************************************************************************/
		function renderGrid() {
			const grid = document.getElementById("mangaGrid"); const empty = document.getElementById("noResults");
			if (!filteredManga.length) {grid.innerHTML = ""; empty.style.display = "block"; document.getElementById("loadMoreBtn").style.display = "none"; return;}
			empty.style.display = "none";
			const frag = document.createDocumentFragment();
			filteredManga.slice(0, itemsShown).forEach(m => frag.appendChild(createCard(m)));
			grid.innerHTML = ""; grid.appendChild(frag);
			document.getElementById("loadMoreBtn").style.display = itemsShown < filteredManga.length ? "block" : "none";
			updateCounts();
		}

		function createCard(m) {
			const card = document.createElement("div"); card.className = "manga-card"; card.onclick = () => openManga(m.number);
			const thumbHTML = `<img class="manga-thumb" data-number="${m.number}" alt="thumb">`;
			const tags = [...(m.artists || []).map(t => ({...t, tType: "artist"})), ...(m.characters || []).map(t => ({...t, tType: "character"})), ...(m.parodies || []).map(t => ({...t, tType: "parody"})), ...(m.categories || []).map(t => ({...t, tType: "category"})), ...(m.languages || []).map(t => ({...t, tType: "language"})), ...(m.groups || []).map(t => ({...t, tType: "group"})), ...(m.tags || []).map(t => ({...t, tType: "tag"}))];
			card.innerHTML = `${thumbHTML}<div class="manga-number">#${m.number}</div><div class="manga-info">${m.pages} pages</div><div class="manga-info">${m.time_relative || "–"}</div>${m.artists?.[0] ? `<div class=\"manga-info\">by ${m.artists[0].name}</div>` : ""}<div class="manga-tags">${tags.map(t => `<span class="tag ${t.tType}">${t.name}</span>`).join("")}</div>`;
			if (previewsOn) thumbObserver.observe(card.querySelector(".manga-thumb"));
			return card;
		}

		function loadThumb(img) {
			if (img.dataset.loaded) return; const num = img.dataset.number; let idx = 0;
			const tryNext = () => {if (idx >= supportedFormats.length) {img.closest('.manga-card')?.remove(); updateCounts(); return;} img.src = `${num}/1.${supportedFormats[idx++]}`;};
			img.onload = () => {img.dataset.loaded = true;};
			img.onerror = tryNext; tryNext();
		}

		/*****************************************************************************
		 * STATS & COUNTS                                                           *
		 *****************************************************************************/
		function updateStats() {const el = document.getElementById("statsDisplay"); if (!mangaData.length) {el.textContent = "No manga loaded"; return;} const pages = mangaData.reduce((s, m) => s + m.pages, 0); el.textContent = `${mangaData.length} manga • ${pages} pages`;}
		function updateCounts() {document.getElementById("resultsCount").textContent = `${Math.min(itemsShown, filteredManga.length)} / ${filteredManga.length}`;}

		/*****************************************************************************
		 * VIEW OPTIONS                                                             *
		 *****************************************************************************/
		function setCompact(c) {document.getElementById("mangaGrid").classList.toggle("compact", c); document.getElementById("normalView").classList.toggle("active", !c); document.getElementById("compactView").classList.toggle("active", c);}
		function togglePreviews() {previewsOn = !previewsOn; document.body.classList.toggle("no-previews", !previewsOn); document.getElementById("previewToggle").textContent = previewsOn ? "Hide Thumbs" : "Show Thumbs"; if (previewsOn) {document.querySelectorAll(".manga-thumb:not([data-loaded])").forEach(img => thumbObserver.observe(img));} else {document.querySelectorAll(".manga-thumb").forEach(img => thumbObserver.unobserve(img));} }

		/*****************************************************************************
		 * READER                                                                   *
		 *****************************************************************************/
		function openManga(num) {currentManga = num; const meta = mangaData.find(m => m.number === num); if (!meta) return; maxPage = meta.pages; currentPage = 1; document.getElementById("totalPages").textContent = maxPage; document.getElementById("pageInput").value = 1; document.getElementById("libraryView").style.display = "none"; document.getElementById("readerView").classList.add("active"); loadPage();}
		function loadPage() {const img = document.getElementById("mangaImage"); const loader = document.getElementById("loading"); const err = document.getElementById("error"); let idx = 0; const tryNext = () => {if (idx >= supportedFormats.length) {loader.style.display = "none"; err.style.display = "block"; return;} img.src = `${currentManga}/${currentPage}.${supportedFormats[idx++]}`;}; img.onload = () => {loader.style.display = "none"; err.style.display = "none"; img.classList.add("active")}; img.onerror = () => {img.classList.remove("active"); tryNext();}; loader.style.display = "block"; img.classList.remove("active"); tryNext();}
		function nextPage() {if (currentPage >= maxPage) return; currentPage++; document.getElementById("pageInput").value = currentPage; loadPage();}
		function previousPage() {if (currentPage <= 1) return; currentPage--; document.getElementById("pageInput").value = currentPage; loadPage();}
		function gotoPage(n) {if (n < 1 || n > maxPage) return; currentPage = n; loadPage();}
		function backToLibrary() {document.getElementById("readerView").classList.remove("active"); document.getElementById("libraryView").style.display = ""; document.exitFullscreen?.();}
		function toggleFullscreen() {const rv = document.getElementById("readerView"); if (!document.fullscreenElement) {rv.requestFullscreen?.();} else {document.exitFullscreen?.();} }
	</script>
</body>

</html>
